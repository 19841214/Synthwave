<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEON SHORTCUT RUNNER: GREEN LIGHT FIX</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Audiowide&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #050010;
    font-family: 'Press Start 2P', cursive;
    color: white;
    user-select: none;
  }

  /* --- CRT Ëû¢ÂπïÁâπÊïàÂ±§ --- */
  #crt-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 100;
    background: 
      linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
      linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
    background-size: 100% 2px, 3px 100%;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
  }

  @keyframes flicker {
    0% { opacity: 0.97; }
    5% { opacity: 0.95; }
    10% { opacity: 0.9; }
    15% { opacity: 0.95; }
    100% { opacity: 0.97; }
  }
  #game-container {
    animation: flicker 0.15s infinite;
  }

  /* UI ‰ªãÈù¢ */
  #ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    pointer-events: none;
    z-index: 50;
    text-shadow: 2px 2px 0px #000, 0 0 10px rgba(255, 0, 255, 0.8);
  }

  .hud-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    font-size: 1.2rem;
    color: #0ff;
  }
  
  .hud-left-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    text-align: left;
  }

  .hud-bottom {
    text-align: center;
    font-family: 'Audiowide', cursive;
    color: #888;
    font-size: 0.8rem;
    letter-spacing: 2px;
  }
  
  /* ÊÑõÂøÉÊ®£Âºè */
  #lives-display {
    color: #ff3333;
    text-shadow: 0 0 10px #ff0000;
    font-size: 1.5rem;
  }

  /* ÈÄöÁî®ÂÖ®Ëû¢ÂπïË¶ÜËìãÂ±§ */
  .fullscreen-overlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 60;
    width: 100%;
    height: 100%;
    display: none;
    background: rgba(5, 0, 16, 0.9);
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  h1 {
    font-family: 'Audiowide', cursive;
    font-size: 4rem;
    margin: 0;
    background: linear-gradient(to bottom, #0ff, #f0f);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 20px #f0f);
    letter-spacing: 5px;
    text-transform: uppercase;
  }

  /* Ê≠°ËøéÊåâÈàï */
  .init-btn {
    margin-top: 50px;
    padding: 20px 40px;
    font-family: 'Audiowide', cursive;
    font-size: 1.5rem;
    background: transparent;
    color: #0ff;
    border: 2px solid #0ff;
    border-radius: 5px;
    cursor: pointer;
    box-shadow: 0 0 15px #0ff;
    transition: all 0.3s;
    pointer-events: auto;
  }
  .init-btn:hover {
    background: #0ff;
    color: #000;
    transform: scale(1.1);
  }

  /* Âø´Êç∑ÈçµÂàóË°®Ê®£Âºè */
  .shortcut-list-container {
    margin-top: 20px;
    max-height: 40vh;
    overflow-y: auto;
    width: 80%;
    max-width: 600px;
    border: 1px solid #555;
    background: rgba(0,0,0,0.8);
    padding: 15px;
    border-radius: 10px;
    pointer-events: auto;
  }
  
  .shortcut-list-container::-webkit-scrollbar { width: 5px; }
  .shortcut-list-container::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; }

  .list-title {
    color: #ff0;
    font-size: 0.8rem;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .shortcut-item {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px dashed #333;
    padding: 8px 0;
    font-size: 0.9rem;
    font-family: monospace;
  }
  .shortcut-item:last-child { border-bottom: none; }
  .sc-label { color: #fff; }
  .sc-keys { color: #0ff; font-weight: bold; }

  /* Victory Â∞àÁî® */
  .victory-title {
    font-size: 5rem;
    background: linear-gradient(to bottom, #fff, #0ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 30px #0ff;
    animation: glitch 1s infinite;
  }
  
  .bonus-section {
    border-color: #0ff;
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
  }
  .bonus-title { color: #0ff; }
  .bonus-item .sc-keys { color: #ff00de; }

  @keyframes glitch {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
  }

  .menu-options {
    margin-top: 40px;
    display: flex;
    justify-content: center;
    gap: 40px;
  }

  .option {
    border: 2px solid #555;
    padding: 20px;
    border-radius: 10px;
    color: #888;
    transition: all 0.3s;
    background: rgba(0,0,0,0.5);
    cursor: pointer;
    pointer-events: auto;
  }
  
  .option.highlight {
    border-color: #0ff;
    color: #fff;
    box-shadow: 0 0 20px #0ff;
    transform: scale(1.1);
  }

  .key-badge {
    display: block;
    font-size: 2rem;
    color: #ff0;
    margin-bottom: 10px;
  }

  .blink-text {
    margin-top: 30px;
    font-size: 1rem;
    color: #aaa;
    animation: blink 1s steps(2, start) infinite;
  }
  
  .rank-badge {
    font-size: 2rem;
    color: #ff0;
    margin: 10px 0;
    text-shadow: 0 0 20px #ff0;
  }

  @keyframes blink {
    to { visibility: hidden; }
  }

  /* Á≠îÂ∞çÈ£ÑÂ≠ó */
  .floating-text {
    position: absolute;
    color: #fff;
    font-weight: bold;
    pointer-events: none;
    animation: floatUp 1s forwards;
    text-shadow: 0 0 5px #fff;
  }

  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
  }
  
  /* ÈóúÂç°ÈÅéÂ†¥ÊñáÂ≠ó */
  #level-transition {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 70;
    pointer-events: none;
    display: none;
  }
  
  .level-title {
    font-family: 'Audiowide', cursive;
    font-size: 3rem;
    color: #ff0;
    text-shadow: 0 0 20px #ff0;
    margin-bottom: 10px;
  }
  
  .level-subtitle {
    font-size: 1.5rem;
    color: #fff;
    letter-spacing: 3px;
  }
</style>
</head>
<body>

<div id="crt-overlay"></div>

<div id="ui-layer">
  <div class="hud-top">
    <div class="hud-left-group">
      <div id="lives-display">‚ù§‚ù§‚ù§‚ù§‚ù§</div>
      <div id="score-display">SCORE: 000000</div>
    </div>
    
    <div id="level-display">SYSTEM IDLE</div>
    <div id="combo-display">COMBO: 0</div>
  </div>
  <div class="hud-bottom" id="system-status">
    WAITING FOR USER INPUT...
  </div>
</div>

<!-- 1. Ê≠°ËøéÁï´Èù¢ -->
<div id="welcome-screen" class="fullscreen-overlay" style="display:flex;">
  <h1>NEON<br>RUNNER</h1>
  <div style="margin-top:20px; font-size: 0.8rem; color: #888;">KEYBOARD SHORTCUT TRAINING PROGRAM</div>
  
  <!-- Êñ∞Â¢ûÔºöSearch Èçµ‰ΩçÁΩÆÊèêÁ§∫ -->
  <div style="margin-top:20px; padding: 10px; border: 1px dashed #555; color: #ff00de; font-size: 0.6rem; line-height: 1.5;">
    <div>‚ö†Ô∏è CHROMEBOOK USER GUIDE:</div>
    <div style="color: #fff; margin-top:5px;">SEARCH KEY (üîç) IS LOCATED AT <span style="color:#0ff">CAPS LOCK</span> POSITION</div>
  </div>

  <button class="init-btn" onclick="window.initSystem()">INITIALIZE SYSTEM</button>
</div>

<!-- 2. ÈÅ∏ÂñÆÁï´Èù¢ -->
<div id="start-screen" class="fullscreen-overlay">
  <h1>SELECT<br>SYSTEM</h1>
  <div class="menu-options">
    <div class="option" id="opt-chrome" onclick="window.selectSystemByClick('CHROMEBOOK')">
      <span class="key-badge">[C]</span>
      CHROMEBOOK
    </div>
    <div class="option" id="opt-win" onclick="window.selectSystemByClick('WINDOWS')">
      <span class="key-badge">[W]</span>
      WINDOWS
    </div>
  </div>
  <div class="blink-text">PRESS KEY TO SELECT</div>
</div>

<!-- 3. ÂãùÂà©Áï´Èù¢ -->
<div id="victory-screen" class="fullscreen-overlay">
  <h1 class="victory-title">SYSTEM<br>HACKED</h1>
  <div class="rank-badge">RANK: S (CYBER GOD)</div>
  <div class="blink-text" id="victory-score" style="margin-top:0;">FINAL SCORE: 000000</div>
  
  <div class="shortcut-list-container bonus-section">
    <div class="list-title bonus-title">SECRET DATA UNLOCKED (BONUS HACKS)</div>
    <div id="victory-list-content"></div>
  </div>

  <div class="blink-text" style="margin-top:20px; color:#fff; font-size:0.8rem;">PRESS [ENTER] TO REBOOT</div>
</div>

<!-- 4. Game Over Áï´Èù¢ -->
<div id="gameover-screen" class="fullscreen-overlay">
  <h1>GAME<br>OVER</h1>
  <div class="blink-text" id="gameover-score" style="margin-top:0;">FINAL SCORE: 0</div>
  
  <div class="shortcut-list-container">
    <div class="list-title">REVIEW FAILED PROTOCOLS (LEVEL DATA)</div>
    <div id="gameover-list-content"></div>
  </div>

  <div class="blink-text" style="margin-top:20px; font-size:0.8rem;">PRESS [ENTER] TO RESTART</div>
</div>

<div id="level-transition">
    <div class="level-title" id="trans-title">LEVEL UP</div>
    <div class="level-subtitle" id="trans-sub">GET READY</div>
</div>

<div id="game-container">
  <canvas id="canvas"></canvas>
</div>

<script>
(function() { 

  /**
   * üéµ Èü≥ÊïàÁÆ°ÁêÜÁ≥ªÁµ±
   */
  const AudioSys = {
    sounds: {},
    currentBGM: null,
    isMuted: false,
    initialized: false,
    
    urls: {
      hit: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_297f73b4ca.mp3?filename=freesound_community-zap_c_07-82067.mp3',
      explode: 'https://cdn.pixabay.com/download/audio/2022/03/19/audio_97dada842f.mp3?filename=freesound_community-8-bit-explosion-95847.mp3',
      error: 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_6b59debae7.mp3?filename=freesound_community-wronganswer-37702.mp3',
      levelup: 'https://cdn.pixabay.com/download/audio/2024/01/02/audio_bba05ac859.mp3?filename=floraphonic-you-win-sequence-1-183948.mp3',
      ui: 'https://cdn.pixabay.com/download/audio/2025/07/13/audio_fad29823bb.mp3?filename=arnav_geddada-ui-sound-374228.mp3',
      bgm_menu: 'https://cdn.pixabay.com/download/audio/2024/10/01/audio_c3c5abd3cf.mp3?filename=khemrajdotin-chillwave-flow-short-version-246321.mp3',
      bgm_game: 'https://cdn.pixabay.com/download/audio/2025/04/21/audio_ed6f0ed574.mp3?filename=vasilyatsevich-brain-implant-cyberpunk-sci-fi-trailer-action-intro-330416.mp3',
      bgm_victory: 'https://cdn.pixabay.com/download/audio/2025/11/26/audio_912e318fcc.mp3?filename=delosound-synthwave-retro-80s-442850.mp3'
    },

    init: function() {
      if (this.initialized) return;
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      this.ctx = new AudioContext();

      for (const [key, url] of Object.entries(this.urls)) {
        this.sounds[key] = new Audio(url);
        if (key.startsWith('bgm_')) {
          this.sounds[key].loop = true;
          this.sounds[key].volume = 0.5;
        } else {
          this.sounds[key].volume = 0.8;
        }
      }
      
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          this.pauseAll();
        } else {
          this.resumeAll();
        }
      });

      this.initialized = true;
    },

    playSFX: function(name) {
      if (!this.initialized || this.isMuted || !this.sounds[name]) return;
      const sound = this.sounds[name].cloneNode();
      sound.volume = this.sounds[name].volume;
      sound.play().catch(e => console.log("Audio play blocked:", e));
    },

    playBGM: function(name) {
      if (!this.initialized || this.isMuted) return;
      if (this.currentBGM && this.currentBGM === this.sounds[name] && !this.currentBGM.paused) return;
      this.stopBGM();
      if (this.sounds[name]) {
        this.currentBGM = this.sounds[name];
        this.currentBGM.currentTime = 0;
        this.currentBGM.play().catch(e => console.log("BGM play blocked:", e));
      }
    },

    stopBGM: function() {
      if (this.currentBGM) {
        this.currentBGM.pause();
        this.currentBGM.currentTime = 0;
        this.currentBGM = null;
      }
    },

    pauseAll: function() {
      if (this.currentBGM) {
        this.currentBGM.pause();
      }
      this.isMuted = true;
    },

    resumeAll: function() {
      this.isMuted = false;
      if (this.currentBGM) {
        this.currentBGM.play().catch(e => {});
      }
    }
  };

  /**
   * üéÆ È°åÂ∫´Ë≥áÊñô (100% GREEN LIGHT SAFE MODE)
   */
  const COMMON_LV1 = [
    { label: "Ë§áË£Ω", hint: "Ctrl+C", code: { ctrl: true, key: 'c' } },
    { label: "Ë≤º‰∏ä", hint: "Ctrl+V", code: { ctrl: true, key: 'v' } },
    { label: "Ââ™‰∏ã", hint: "Ctrl+X", code: { ctrl: true, key: 'x' } },
    { label: "ÂÖ®ÈÅ∏", hint: "Ctrl+A", code: { ctrl: true, key: 'a' } },
    { label: "Âæ©Âéü", hint: "Ctrl+Z", code: { ctrl: true, key: 'z' } },
    { label: "ÊêúÂ∞ã", hint: "Ctrl+F", code: { ctrl: true, key: 'f' } },
    { label: "Â≠òÊ™î", hint: "Ctrl+S", code: { ctrl: true, key: 's' } }
  ];

  const COMMON_LV2 = [
    { label: "Á≤óÈ´î", hint: "Ctrl+B", code: { ctrl: true, key: 'b' } },
    { label: "ÊñúÈ´î", hint: "Ctrl+I", code: { ctrl: true, key: 'i' } },
    { label: "Â∫ïÁ∑ö", hint: "Ctrl+U", code: { ctrl: true, key: 'u' } },
    { label: "Êõ∏Á±§", hint: "Ctrl+D", code: { ctrl: true, key: 'd' } },
    { label: "Ê≠∑Âè≤", hint: "Ctrl+H", code: { ctrl: true, key: 'h' } },
    { label: "‰∏ãËºâ", hint: "Ctrl+J", code: { ctrl: true, key: 'j' } }
  ];

  const GAME_DATA = {
    CHROMEBOOK: [
      { name: "SURVIVOR", color: "#00ffff", speed: 200, pool: COMMON_LV1, gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"] },
      { name: "EDITOR", color: "#ff00ff", speed: 250, pool: COMMON_LV2, gridColor: "#00ffff", sunColors: ["#ffffff", "#00ffff"] },
      { name: "HACKER", color: "#ffff00", speed: 320, pool: [
          { label: "Êõ∏Á±§Âàó", hint: "Ctrl+Shift+B", code: { ctrl: true, shift: true, key: 'b' } },
          { label: "ÈáçÊï¥", hint: "Ctrl+R", code: { ctrl: true, key: 'r' } },
          { label: "Á°¨ÈáçÊï¥", hint: "Ctrl+Shift+R", code: { ctrl: true, shift: true, key: 'r' } },
          { label: "Á∂≤ÂùÄÂàó", hint: "Ctrl+L", code: { ctrl: true, key: 'l' } }
        ], gridColor: "#ff0000", sunColors: ["#ffff00", "#ff0000"] },
      { name: "GOD MODE", color: "#ffffff", speed: 380, pool: [
          { label: "È†ÅÈ¶ñHome", hint: "Search+‚Üê", code: { meta: true, key: 'ArrowLeft' } },
          { label: "È†ÅÂ∞æEnd", hint: "Search+‚Üí", code: { meta: true, key: 'ArrowRight' } },
          { label: "‰∏ä‰∏ÄÈ†Å", hint: "Alt+‚Üê", code: { alt: true, key: 'ArrowLeft' } },
          { label: "‰∏ã‰∏ÄÈ†Å", hint: "Alt+‚Üí", code: { alt: true, key: 'ArrowRight' } },
          { label: "ÂÖ®Ëû¢Âπï", hint: "F4 (üîç+4)", code: { key: 'F4' } } 
        ], gridColor: "#ffffff", sunColors: ["#ffffff", "#ffffff"] }
    ],
    WINDOWS: [
      { name: "SURVIVOR", color: "#00ffff", speed: 200, pool: COMMON_LV1, gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"] },
      { name: "EDITOR", color: "#ff00ff", speed: 250, pool: COMMON_LV2, gridColor: "#00ffff", sunColors: ["#ffffff", "#00ffff"] },
      { name: "POWERUSER", color: "#00ff00", speed: 300, pool: [
          { label: "È†ÅÈ¶ñ", hint: "Home", code: { key: 'Home' } },
          { label: "È†ÅÂ∞æ", hint: "End", code: { key: 'End' } },
          { label: "Á∂≤ÂùÄÂàó", hint: "Alt+D", code: { alt: true, key: 'd' } },
          { label: "Á°¨ÈáçÊï¥", hint: "Ctrl+F5", code: { ctrl: true, key: 'F5' } }
        ], gridColor: "#00ff00", sunColors: ["#ccffcc", "#008800"] },
      { name: "GOD MODE", color: "#ffffff", speed: 380, pool: [
          { label: "Êõ∏Á±§Âàó", hint: "Ctrl+Shift+B", code: { ctrl: true, shift: true, key: 'b' } },
          { label: "ÂéüÂßãÁ¢º", hint: "Ctrl+U", code: { ctrl: true, key: 'u' } },
          { label: "Â∞ãÊâæ", hint: "Ctrl+G", code: { ctrl: true, key: 'g' } },
          { label: "ÈáçÊï¥", hint: "Ctrl+R", code: { ctrl: true, key: 'r' } }
        ], gridColor: "#ffffff", sunColors: ["#ffffff", "#ffffff"] }
    ]
  };

  const BONUS_SHORTCUTS = {
    CHROMEBOOK: [
      { label: "ÊïëÂõûÂàÜÈ†Å", hint: "Ctrl + Shift + T" },
      { label: "Âø´Êç∑ÈçµË°®", hint: "Ctrl + Alt + /" },
      { label: "ÈéñÂÆöËû¢Âπï", hint: "Search + L" },
      { label: "Ê™îÊ°àÁ∏ΩÁÆ°", hint: "Alt + Shift + M" },
      { label: "‰ªªÂãôÁÆ°ÁêÜ", hint: "Search + Esc" }
    ],
    WINDOWS: [
      { label: "ÈéñÂÆöÈõªËÖ¶", hint: "Win + L" },
      { label: "È°ØÁ§∫Ê°åÈù¢", hint: "Win + D" },
      { label: "ÂçÄÂüüÊà™Âúñ", hint: "Win + Shift + S" },
      { label: "Â∑•‰ΩúÁÆ°ÁêÜ", hint: "Ctrl + Shift + Esc" },
      { label: "ÈÄ≤ÈöéÈÅ∏ÂñÆ", hint: "Win + X" }
    ]
  };

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let state = {
    screen: 'WELCOME', 
    system: 'CHROMEBOOK',
    score: 0,
    combo: 0,
    lives: 5,
    levelIdx: 0,
    shake: 0, 
    lastTime: 0,
    transitionTimer: 0,
    damageFlash: 0
  };

  let entities = {
    enemies: [],
    particles: []
  };

  let gameW, gameH, gameCX, gameCY;
  function resize() {
    gameW = canvas.width = window.innerWidth;
    gameH = canvas.height = window.innerHeight;
    gameCX = gameW / 2;
    gameCY = gameH / 2;
  }
  window.addEventListener('resize', resize);
  resize();

  // --- Classes ---

  class Enemy {
    constructor(data) {
      this.data = data;
      this.x = (Math.random() - 0.5) * gameW * 0.8; 
      this.y = gameH * 0.5; 
      this.z = 2000; 
      this.maxZ = 2000;
    }
    update(dt, speed) {
      this.z -= speed * dt;
      return this.z < 10; 
    }
    draw(ctx) {
      const scale = 300 / (this.z + 10);
      const screenX = gameCX + this.x * scale;
      const screenY = gameH * 0.55 + 40 * scale; 
      const currentLevels = GAME_DATA[state.system];
      const levelColor = currentLevels[state.levelIdx].color;

      ctx.save();
      const fontSizeLabel = 70 * scale;
      const fontSizeHint = 25 * scale;
      ctx.font = `${fontSizeLabel}px 'Press Start 2P'`;
      const labelW = ctx.measureText(this.data.label).width;
      const boxWidth = labelW + 60 * scale; 
      const boxHeight = fontSizeLabel + fontSizeHint + 40 * scale;
      const boxX = screenX - boxWidth / 2;
      const boxY = screenY - fontSizeLabel; 

      ctx.fillStyle = "rgba(0, 0, 0, 0.85)"; 
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
      ctx.strokeStyle = levelColor;
      ctx.lineWidth = 3 * scale;
      ctx.shadowBlur = 10;
      ctx.shadowColor = levelColor;
      ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
      ctx.restore();

      ctx.shadowBlur = 20;
      ctx.shadowColor = levelColor;
      ctx.fillStyle = "#fff";
      ctx.font = `${fontSizeLabel}px 'Press Start 2P'`;
      ctx.textAlign = "center";
      ctx.fillText(this.data.label, screenX, screenY + 10 * scale);
      
      ctx.shadowBlur = 0; 
      ctx.fillStyle = levelColor;
      ctx.font = `${fontSizeHint}px monospace`;
      ctx.fillText(this.data.hint, screenX, screenY + 70 * scale);
    }
  }

  class Particle {
    constructor(x, y, color) {
      this.x = x;
      this.y = y;
      this.color = color;
      const angle = Math.random() * Math.PI * 2;
      const speed = Math.random() * 5 + 2;
      this.vx = Math.cos(angle) * speed;
      this.vy = Math.sin(angle) * speed;
      this.life = 1.0;
      this.decay = Math.random() * 0.03 + 0.02;
    }
    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += 0.2;
      this.life -= this.decay;
    }
    draw(ctx) {
      ctx.globalAlpha = Math.max(0, this.life);
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, 4, 4);
      ctx.globalAlpha = 1.0;
    }
  }

  // --- Game Functions ---

  function spawnEnemy() {
    const currentLevels = GAME_DATA[state.system];
    const pool = currentLevels[state.levelIdx].pool;
    const data = pool[Math.floor(Math.random() * pool.length)];
    entities.enemies.push(new Enemy(data));
  }

  function triggerShake(amount) {
    state.shake = amount;
  }

  function createExplosion(x, y, color) {
    for(let i=0; i<15; i++) {
      entities.particles.push(new Particle(x, y, color));
    }
  }

  function updateHUD() {
    document.getElementById('score-display').innerText = `SCORE: ${state.score.toString().padStart(6, '0')}`;
    document.getElementById('combo-display').innerText = `COMBO: ${state.combo}`;
    
    const hearts = "‚ù§".repeat(Math.max(0, state.lives));
    document.getElementById('lives-display').innerText = hearts;

    if (state.screen === 'VICTORY') {
        document.getElementById('level-display').innerText = "SYSTEM HACKED";
        document.getElementById('level-display').style.color = "#fff";
    } else {
        const currentLevels = GAME_DATA[state.system];
        const lvlEl = document.getElementById('level-display');
        lvlEl.innerText = currentLevels[state.levelIdx].name;
        lvlEl.style.color = currentLevels[state.levelIdx].color;
    }

    document.getElementById('system-status').innerText = `SYSTEM: ${state.system}_OS // KEYBOARD_INTERCEPT: ACTIVE`;
  }

  function showTransition(title, subtitle) {
    const el = document.getElementById('level-transition');
    document.getElementById('trans-title').innerText = title;
    document.getElementById('trans-title').style.color = GAME_DATA[state.system][state.levelIdx].color;
    document.getElementById('trans-sub').innerText = subtitle;
    el.style.display = 'block';
    state.transitionTimer = 2.0; 
  }
  
  function generateListHTML(dataArray) {
    return dataArray.map(item => `
      <div class="shortcut-item">
        <span class="sc-label">${item.label}</span>
        <span class="sc-keys">${item.hint}</span>
      </div>
    `).join('');
  }

  // GLOBAL FUNCTIONS
  window.initSystem = function() {
    AudioSys.init();
    AudioSys.playSFX('ui');
    AudioSys.playBGM('bgm_menu');
    
    document.getElementById('welcome-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
    state.screen = 'START';
  };

  window.selectSystemByClick = function(sys) {
    state.system = sys;
    document.querySelectorAll('.option').forEach(el => el.classList.remove('highlight'));
    if(sys === 'CHROMEBOOK') document.getElementById('opt-chrome').classList.add('highlight');
    if(sys === 'WINDOWS') document.getElementById('opt-win').classList.add('highlight');
    
    AudioSys.playSFX('ui');
    setTimeout(() => { startGame(); }, 500);
  }

  function startGame() {
    state.screen = 'PLAY';
    state.score = 0;
    state.combo = 0;
    state.lives = 5; 
    state.levelIdx = 0;
    entities.enemies = [];
    entities.particles = [];
    state.damageFlash = 0;
    
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('victory-screen').style.display = 'none';
    document.getElementById('gameover-screen').style.display = 'none';
    updateHUD();
    
    const currentLevel = GAME_DATA[state.system][0];
    showTransition(`LEVEL 1`, currentLevel.name);
    
    AudioSys.playSFX('levelup'); 
    AudioSys.playBGM('bgm_game');
  }

  function victory() {
    state.screen = 'VICTORY';
    AudioSys.playBGM('bgm_victory'); 
    
    document.getElementById('victory-screen').style.display = 'flex';
    document.getElementById('victory-score').innerText = `FINAL SCORE: ${state.score}`;
    document.getElementById('level-transition').style.display = 'none';
    
    const bonusData = BONUS_SHORTCUTS[state.system];
    document.getElementById('victory-list-content').innerHTML = generateListHTML(bonusData);
    
    updateHUD();
  }

  function gameOver() {
    state.screen = 'GAMEOVER';
    AudioSys.playSFX('error'); 
    AudioSys.stopBGM(); 
    
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('gameover-screen').style.display = 'flex';
    document.getElementById('level-transition').style.display = 'none';
    document.getElementById('gameover-score').innerText = `FINAL SCORE: ${state.score}`;
    
    const currentLevelPool = GAME_DATA[state.system][state.levelIdx].pool;
    document.getElementById('gameover-list-content').innerHTML = generateListHTML(currentLevelPool);
  }

  // --- Main Loop ---

  let spawnTimer = 0;

  function loop(timestamp) {
    const dt = (timestamp - state.lastTime) / 1000;
    state.lastTime = timestamp;

    ctx.fillStyle = "#050010";
    ctx.fillRect(0, 0, gameW, gameH);
    
    ctx.save();
    if (state.shake > 0) {
      const dx = (Math.random() - 0.5) * state.shake;
      const dy = (Math.random() - 0.5) * state.shake;
      ctx.translate(dx, dy);
      state.shake *= 0.9; 
      if(state.shake < 0.5) state.shake = 0;
    }

    drawBackground(timestamp);

    if (state.damageFlash > 0) {
        state.damageFlash -= dt;
        ctx.fillStyle = `rgba(255, 0, 0, ${state.damageFlash * 0.5})`;
        ctx.fillRect(0, 0, gameW, gameH);
    }

    if (state.screen === 'VICTORY') {
        // Victory Loop
    } 
    else if (state.screen === 'PLAY') {
      const currentLevels = GAME_DATA[state.system];
      
      if (state.transitionTimer > 0) {
        state.transitionTimer -= dt;
        if (state.transitionTimer <= 0) {
          document.getElementById('level-transition').style.display = 'none';
        }
      } else {
        spawnTimer += dt;
        const spawnRate = 2.0 - (state.levelIdx * 0.5); 
        if (spawnTimer > spawnRate) {
          spawnEnemy();
          spawnTimer = 0;
        }
      }

      let nextLevel = -1;
      if (state.score > 1500 && state.levelIdx === 0) nextLevel = 1;
      if (state.score > 3500 && state.levelIdx === 1) nextLevel = 2;
      if (state.score > 5500 && state.levelIdx === 2) nextLevel = 3;
      
      if (state.score > 8000) { victory(); }

      if (nextLevel !== -1) {
        state.levelIdx = nextLevel;
        AudioSys.playSFX('levelup');
        triggerShake(10);
        showTransition("LEVEL UP!", currentLevels[state.levelIdx].name);
        updateHUD();
      }

      entities.enemies.forEach((e, i) => {
        const hit = e.update(dt, currentLevels[state.levelIdx].speed);
        if (hit) {
          state.lives--;
          state.combo = 0;
          state.damageFlash = 0.5;
          triggerShake(30);
          AudioSys.playSFX('error'); 
          
          e.z = -1000;

          if (state.lives <= 0) {
             gameOver();
          }
        }
      });
      entities.enemies = entities.enemies.filter(e => e.z > 0);
      entities.enemies.sort((a, b) => b.z - a.z);
      entities.enemies.forEach(e => e.draw(ctx));
      
      updateHUD();
    }

    entities.particles.forEach(p => {
      p.update();
      p.draw(ctx);
    });
    entities.particles = entities.particles.filter(p => p.life > 0);

    ctx.restore();
    requestAnimationFrame(loop);
  }

  function drawBackground(time) {
    const horizonY = gameH * 0.55;
    const sunY = horizonY - 50;
    let currentTheme = { gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"] };
    
    if (state.screen === 'VICTORY') {
        currentTheme = { gridColor: "#ffffff", sunColors: ["#ffffff", "#ccffff"] };
    } else if (state.screen === 'PLAY' || state.screen === 'GAMEOVER') {
        currentTheme = GAME_DATA[state.system][state.levelIdx];
    }

    const sunGrad = ctx.createLinearGradient(gameCX, sunY - 150, gameCX, sunY + 150);
    sunGrad.addColorStop(0, currentTheme.sunColors[0]);
    sunGrad.addColorStop(1, currentTheme.sunColors[1]);
    
    ctx.save();
    ctx.fillStyle = sunGrad;
    ctx.shadowBlur = (state.screen === 'VICTORY') ? 100 : 50; 
    ctx.shadowColor = currentTheme.sunColors[1];
    ctx.beginPath();
    ctx.arc(gameCX, sunY, 120, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = "#050010";
    for(let i=0; i<8; i++) {
      let y = sunY + 20 + i * 15;
      let h = 2 + i * 1.5;
      ctx.fillRect(gameCX - 130, y, 260, h);
    }

    ctx.save();
    ctx.strokeStyle = currentTheme.gridColor;
    ctx.lineWidth = 2;
    ctx.shadowBlur = 10;
    ctx.shadowColor = currentTheme.gridColor;
    
    ctx.beginPath();
    for (let i = -20; i <= 20; i++) {
      let x1 = gameCX + i * 40; 
      let x2 = gameCX + i * 800; 
      ctx.moveTo(x1, horizonY);
      ctx.lineTo(x2, gameH);
    }
    ctx.stroke();

    const speed = (state.screen === 'VICTORY') ? 1500 : 150; 
    const offset = (time / 1000 * speed) % 100;
    ctx.beginPath();
    for (let i = 0; i < 15; i++) {
      let z = i * 80 + offset;
      let y = horizonY + (z * z) / 2000; 
      if (y < gameH) {
        ctx.moveTo(0, y);
        ctx.lineTo(gameW, y);
      }
    }
    ctx.stroke();
    ctx.shadowBlur = 30;
    ctx.shadowColor = "#fff";
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, horizonY);
    ctx.lineTo(gameW, horizonY);
    ctx.stroke();
    ctx.restore();
  }

  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.altKey || e.metaKey || e.key === 'F5' || e.key === 'F11') {
      e.preventDefault();
    }

    if (state.screen === 'WELCOME') return; 

    if (state.screen === 'START') {
      if (e.key.toLowerCase() === 'c') window.selectSystemByClick('CHROMEBOOK');
      if (e.key.toLowerCase() === 'w') window.selectSystemByClick('WINDOWS');
      return;
    }

    if (state.screen === 'GAMEOVER' || state.screen === 'VICTORY') {
      if (e.key === 'Enter') {
        state.screen = 'START';
        document.querySelector('.menu-options').style.display = 'flex';
        document.querySelectorAll('.option').forEach(el => el.classList.remove('highlight'));
        
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('victory-screen').style.display = 'none';
        document.getElementById('gameover-screen').style.display = 'none';
        
        AudioSys.playBGM('bgm_menu'); 
      }
      return;
    }

    if (state.screen !== 'PLAY') return;
    if (state.transitionTimer > 0) return;

    let targetIdx = -1;
    let minZ = Infinity;
    entities.enemies.forEach((en, idx) => {
      if (en.z < minZ) { minZ = en.z; targetIdx = idx; }
    });

    if (targetIdx !== -1) {
      const enemy = entities.enemies[targetIdx];
      const code = enemy.data.code;

      const matchCtrl = !!code.ctrl === e.ctrlKey;
      const matchAlt = !!code.alt === e.altKey;
      const matchMeta = !!code.meta === e.metaKey;
      const matchShift = !!code.shift === e.shiftKey;
      
      let matchKey = false;
      if (code.key) {
        matchKey = e.key.toLowerCase() === code.key.toLowerCase();
      } else {
        matchKey = true; 
      }

      if (matchCtrl && matchAlt && matchMeta && matchShift && matchKey) {
        state.score += 100 + (state.combo * 10);
        state.combo++;
        triggerShake(5);
        AudioSys.playSFX('hit'); 
        setTimeout(() => AudioSys.playSFX('explode'), 50); 
        
        const scale = 300 / (enemy.z + 10);
        const sx = gameCX + enemy.x * scale;
        const sy = gameH * 0.55 + 40 * scale;
        createExplosion(sx, sy, GAME_DATA[state.system][state.levelIdx].color);
        
        const floatText = document.createElement('div');
        floatText.className = 'floating-text';
        floatText.style.left = sx + 'px';
        floatText.style.top = sy + 'px';
        floatText.innerText = "+100";
        document.body.appendChild(floatText);
        setTimeout(() => floatText.remove(), 1000);

        entities.enemies.splice(targetIdx, 1);
      }
    }
  });

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>