<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEON SHORTCUT RUNNER: AUDIO UPGRADE</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Audiowide&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #050010;
    font-family: 'Press Start 2P', cursive;
    color: white;
    user-select: none;
  }

  /* --- CRT è¢å¹•ç‰¹æ•ˆå±¤ --- */
  #crt-overlay {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 100;
    background: 
      linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
      linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
    background-size: 100% 2px, 3px 100%;
    box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
  }

  @keyframes flicker {
    0% { opacity: 0.97; }
    5% { opacity: 0.95; }
    10% { opacity: 0.9; }
    15% { opacity: 0.95; }
    100% { opacity: 0.97; }
  }
  #game-container {
    animation: flicker 0.15s infinite;
  }

  /* UI ä»‹é¢ */
  #ui-layer {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    pointer-events: none;
    z-index: 50;
    text-shadow: 2px 2px 0px #000, 0 0 10px rgba(255, 0, 255, 0.8);
  }

  .hud-top {
    display: flex;
    justify-content: space-between;
    font-size: 1.2rem;
    color: #0ff;
  }

  .hud-bottom {
    text-align: center;
    font-family: 'Audiowide', cursive;
    color: #888;
    font-size: 0.8rem;
    letter-spacing: 2px;
  }

  /* é€šç”¨å…¨è¢å¹•è¦†è“‹å±¤ */
  .fullscreen-overlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 60;
    width: 100%;
    display: none;
  }

  h1 {
    font-family: 'Audiowide', cursive;
    font-size: 4rem;
    margin: 0;
    background: linear-gradient(to bottom, #0ff, #f0f);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 0 20px #f0f);
    letter-spacing: 5px;
  }

  /* Victory å°ˆç”¨æ¨£å¼ */
  .victory-title {
    font-size: 5rem;
    background: linear-gradient(to bottom, #fff, #0ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 30px #0ff;
    animation: glitch 1s infinite;
  }

  @keyframes glitch {
    0% { transform: translate(0); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(-2px, -2px); }
    60% { transform: translate(2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0); }
  }

  .rank-badge {
    font-size: 2rem;
    color: #ff0;
    margin: 20px 0;
    text-shadow: 0 0 20px #ff0;
  }

  .menu-options {
    margin-top: 40px;
    display: flex;
    justify-content: center;
    gap: 40px;
  }

  .option {
    border: 2px solid #555;
    padding: 20px;
    border-radius: 10px;
    color: #888;
    transition: all 0.3s;
    background: rgba(0,0,0,0.5);
    cursor: pointer;
    pointer-events: auto; /* ç¢ºä¿å¯é»æ“Š */
  }
  
  .option.highlight {
    border-color: #0ff;
    color: #fff;
    box-shadow: 0 0 20px #0ff;
    transform: scale(1.1);
  }

  .key-badge {
    display: block;
    font-size: 2rem;
    color: #ff0;
    margin-bottom: 10px;
  }

  .blink-text {
    margin-top: 30px;
    font-size: 1rem;
    color: #aaa;
    animation: blink 1s steps(2, start) infinite;
  }

  @keyframes blink {
    to { visibility: hidden; }
  }

  /* ç­”å°é£„å­— */
  .floating-text {
    position: absolute;
    color: #fff;
    font-weight: bold;
    pointer-events: none;
    animation: floatUp 1s forwards;
    text-shadow: 0 0 5px #fff;
  }

  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
  }
  
  /* é—œå¡éå ´æ–‡å­— */
  #level-transition {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 70;
    pointer-events: none;
    display: none;
  }
  
  .level-title {
    font-family: 'Audiowide', cursive;
    font-size: 3rem;
    color: #ff0;
    text-shadow: 0 0 20px #ff0;
    margin-bottom: 10px;
  }
  
  .level-subtitle {
    font-size: 1.5rem;
    color: #fff;
    letter-spacing: 3px;
  }
</style>
</head>
<body>

<div id="crt-overlay"></div>

<div id="ui-layer">
  <div class="hud-top">
    <div id="score-display">SCORE: 000000</div>
    <div id="combo-display">COMBO: 0</div>
    <div id="level-display">SYSTEM IDLE</div>
  </div>
  <div class="hud-bottom" id="system-status">
    SELECT SYSTEM TO BOOT...
  </div>
</div>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start-screen" class="fullscreen-overlay" style="display:block;">
  <h1>NEON<br>RUNNER</h1>
  <div class="menu-options">
    <div class="option" id="opt-chrome" onclick="window.selectSystemByClick('CHROMEBOOK')">
      <span class="key-badge">[C]</span>
      CHROMEBOOK
    </div>
    <div class="option" id="opt-win" onclick="window.selectSystemByClick('WINDOWS')">
      <span class="key-badge">[W]</span>
      WINDOWS
    </div>
  </div>
  <div class="blink-text">PRESS KEY TO SELECT SYSTEM</div>
  <div style="margin-top:20px; font-size: 0.7rem; color: #555;">(Click to enable Audio)</div>
</div>

<!-- å‹åˆ©ç•«é¢ -->
<div id="victory-screen" class="fullscreen-overlay">
  <h1 class="victory-title">SYSTEM<br>HACKED</h1>
  <div class="rank-badge">RANK: S (CYBER GOD)</div>
  <div class="blink-text" id="victory-score">FINAL SCORE: 000000</div>
  <div class="blink-text" style="margin-top:10px; color:#fff;">PRESS [ENTER] TO REBOOT</div>
</div>

<!-- Game Over ç•«é¢ -->
<div id="gameover-screen" class="fullscreen-overlay">
  <h1>GAME<br>OVER</h1>
  <div class="blink-text" id="gameover-score">FINAL SCORE: 0</div>
  <div class="blink-text" style="margin-top:20px;">PRESS [ENTER] TO RESTART</div>
</div>

<div id="level-transition">
    <div class="level-title" id="trans-title">LEVEL UP</div>
    <div class="level-subtitle" id="trans-sub">GET READY</div>
</div>

<div id="game-container">
  <canvas id="canvas"></canvas>
</div>

<script>
(function() { 

  /**
   * ğŸµ éŸ³æ•ˆç®¡ç†ç³»çµ± (Updated)
   * æ”¯æ´ MP3 æª”æ¡ˆæ’­æ”¾ã€BGM å¾ªç’°èˆ‡åˆ‡æ›ã€å¤±ç„¦æš«åœ
   */
  const AudioSys = {
    sounds: {},
    currentBGM: null,
    isMuted: false,
    
    // éŸ³æ•ˆè³‡æº URL
    urls: {
      hit: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_297f73b4ca.mp3?filename=freesound_community-zap_c_07-82067.mp3',
      explode: 'https://cdn.pixabay.com/download/audio/2022/03/19/audio_97dada842f.mp3?filename=freesound_community-8-bit-explosion-95847.mp3',
      error: 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_6b59debae7.mp3?filename=freesound_community-wronganswer-37702.mp3',
      levelup: 'https://cdn.pixabay.com/download/audio/2024/01/02/audio_bba05ac859.mp3?filename=floraphonic-you-win-sequence-1-183948.mp3',
      ui: 'https://cdn.pixabay.com/download/audio/2025/07/13/audio_fad29823bb.mp3?filename=arnav_geddada-ui-sound-374228.mp3',
      
      // BGM
      bgm_menu: 'https://cdn.pixabay.com/download/audio/2024/10/01/audio_c3c5abd3cf.mp3?filename=khemrajdotin-chillwave-flow-short-version-246321.mp3',
      bgm_game: 'https://cdn.pixabay.com/download/audio/2025/04/21/audio_ed6f0ed574.mp3?filename=vasilyatsevich-brain-implant-cyberpunk-sci-fi-trailer-action-intro-330416.mp3',
      bgm_victory: 'https://cdn.pixabay.com/download/audio/2025/11/26/audio_912e318fcc.mp3?filename=delosound-synthwave-retro-80s-442850.mp3'
    },

    init: function() {
      // é è¼‰å…¥æ‰€æœ‰éŸ³æ•ˆ
      for (const [key, url] of Object.entries(this.urls)) {
        this.sounds[key] = new Audio(url);
        // BGM è¨­å®šå¾ªç’°
        if (key.startsWith('bgm_')) {
          this.sounds[key].loop = true;
          this.sounds[key].volume = 0.5; // BGM éŸ³é‡ç¨å¾®å°ä¸€é»
        } else {
          this.sounds[key].volume = 0.8;
        }
      }
      
      // ç›£è½é é¢å¯è¦‹åº¦æ”¹è®Š (åˆ‡æ›åˆ†é æ™‚æš«åœè²éŸ³)
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
          this.pauseAll();
        } else {
          this.resumeAll();
        }
      });
    },

    playSFX: function(name) {
      if (this.isMuted || !this.sounds[name]) return;
      
      // è¤‡è£½ç¯€é»ä»¥æ”¯æ´é‡ç–Šæ’­æ”¾ (ä¾‹å¦‚å¿«é€Ÿé€£çºŒç­”å°)
      const sound = this.sounds[name].cloneNode();
      sound.volume = this.sounds[name].volume;
      sound.play().catch(e => console.log("Audio play blocked:", e));
    },

    playBGM: function(name) {
      if (this.isMuted) return;
      
      // å¦‚æœå·²ç¶“åœ¨æ’­åŒä¸€é¦–ï¼Œå°±ä¸é‡æ’­
      if (this.currentBGM && this.currentBGM === this.sounds[name] && !this.currentBGM.paused) return;

      this.stopBGM(); // åœæ‰ä¸Šä¸€é¦–

      if (this.sounds[name]) {
        this.currentBGM = this.sounds[name];
        this.currentBGM.currentTime = 0;
        this.currentBGM.play().catch(e => console.log("BGM play blocked:", e));
      }
    },

    stopBGM: function() {
      if (this.currentBGM) {
        this.currentBGM.pause();
        this.currentBGM.currentTime = 0;
        this.currentBGM = null;
      }
    },

    pauseAll: function() {
      if (this.currentBGM) {
        this.currentBGM.pause();
      }
      this.isMuted = true;
    },

    resumeAll: function() {
      this.isMuted = false;
      if (this.currentBGM) {
        this.currentBGM.play().catch(e => {});
      }
    }
  };

  // åˆå§‹åŒ–éŸ³è¨Šç³»çµ±
  AudioSys.init();


  /**
   * ğŸ® é¡Œåº«è³‡æ–™ (é›™ç³»çµ±) + é…è‰²ä¸»é¡Œ
   */
  const COMMON_LV1 = [
    { label: "è¤‡è£½", hint: "Ctrl+C", code: { ctrl: true, key: 'c' } },
    { label: "è²¼ä¸Š", hint: "Ctrl+V", code: { ctrl: true, key: 'v' } },
    { label: "å‰ªä¸‹", hint: "Ctrl+X", code: { ctrl: true, key: 'x' } },
    { label: "å…¨é¸", hint: "Ctrl+A", code: { ctrl: true, key: 'a' } },
    { label: "å¾©åŸ", hint: "Ctrl+Z", code: { ctrl: true, key: 'z' } },
    { label: "æœå°‹", hint: "Ctrl+F", code: { ctrl: true, key: 'f' } },
    { label: "å­˜æª”", hint: "Ctrl+S", code: { ctrl: true, key: 's' } }
  ];

  const COMMON_LV2 = [
    { label: "ç²—é«”", hint: "Ctrl+B", code: { ctrl: true, key: 'b' } },
    { label: "æ–œé«”", hint: "Ctrl+I", code: { ctrl: true, key: 'i' } },
    { label: "åº•ç·š", hint: "Ctrl+U", code: { ctrl: true, key: 'u' } },
    { label: "æ›¸ç±¤", hint: "Ctrl+D", code: { ctrl: true, key: 'd' } },
    { label: "æ­·å²", hint: "Ctrl+H", code: { ctrl: true, key: 'h' } },
    { label: "ä¸‹è¼‰", hint: "Ctrl+J", code: { ctrl: true, key: 'j' } }
  ];

  const GAME_DATA = {
    CHROMEBOOK: [
      { 
        name: "SURVIVOR", color: "#00ffff", speed: 200, pool: COMMON_LV1,
        gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"] 
      },
      { 
        name: "EDITOR", color: "#ff00ff", speed: 250, pool: COMMON_LV2,
        gridColor: "#00ffff", sunColors: ["#ffffff", "#00ffff"] 
      },
      { 
        name: "HACKER", color: "#ffff00", speed: 320,
        pool: [
          { label: "é å·¦", hint: "Alt+[", code: { alt: true, key: '[' } },
          { label: "é å³", hint: "Alt+]", code: { alt: true, key: ']' } },
          { label: "å¤§å¯«", hint: "Alt+ğŸ”", code: { alt: true, meta: true } },
          { label: "åˆªé™¤", hint: "Alt+Back", code: { alt: true, key: 'Backspace' } }
        ],
        gridColor: "#ff0000", sunColors: ["#ffff00", "#ff0000"] 
      }
    ],
    WINDOWS: [
      { 
        name: "SURVIVOR", color: "#00ffff", speed: 200, pool: COMMON_LV1,
        gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"]
      },
      { 
        name: "EDITOR", color: "#ff00ff", speed: 250, pool: COMMON_LV2,
        gridColor: "#00ffff", sunColors: ["#ffffff", "#00ffff"]
      },
      { 
        name: "POWERUSER", color: "#00ff00", speed: 300,
        pool: [
          { label: "ä¸Šä¸€é ", hint: "Alt+â†", code: { alt: true, key: 'ArrowLeft' } },
          { label: "ä¸‹ä¸€é ", hint: "Alt+â†’", code: { alt: true, key: 'ArrowRight' } },
          { label: "é‡æ•´", hint: "F5", code: { key: 'F5' } },
          { label: "å…¨è¢å¹•", hint: "F11", code: { key: 'F11' } },
          { label: "ç®¡ç†å“¡", hint: "Shift+Esc", code: { shift: true, key: 'Escape' } },
          { label: "ç¶²å€åˆ—", hint: "Ctrl+L", code: { ctrl: true, key: 'l' } }
        ],
        gridColor: "#00ff00", sunColors: ["#ccffcc", "#008800"]
      }
    ]
  };

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let state = {
    screen: 'START', // START, PLAY, GAMEOVER, VICTORY
    system: 'CHROMEBOOK',
    score: 0,
    combo: 0,
    levelIdx: 0,
    shake: 0, 
    lastTime: 0,
    transitionTimer: 0
  };

  let entities = {
    enemies: [],
    particles: []
  };

  let gameW, gameH, gameCX, gameCY;
  function resize() {
    gameW = canvas.width = window.innerWidth;
    gameH = canvas.height = window.innerHeight;
    gameCX = gameW / 2;
    gameCY = gameH / 2;
  }
  window.addEventListener('resize', resize);
  resize();

  // --- Classes ---

  class Enemy {
    constructor(data) {
      this.data = data;
      this.x = (Math.random() - 0.5) * gameW * 0.8; 
      this.y = gameH * 0.5; 
      this.z = 2000; 
      this.maxZ = 2000;
    }

    update(dt, speed) {
      this.z -= speed * dt;
      return this.z < 10; 
    }

    draw(ctx) {
      const scale = 300 / (this.z + 10);
      const screenX = gameCX + this.x * scale;
      const screenY = gameH * 0.55 + 40 * scale; 
      
      const currentLevels = GAME_DATA[state.system];
      const levelColor = currentLevels[state.levelIdx].color;

      // HUD èƒŒæ™¯æ¡†
      ctx.save();
      const fontSizeLabel = 70 * scale;
      const fontSizeHint = 25 * scale;
      ctx.font = `${fontSizeLabel}px 'Press Start 2P'`;
      const labelW = ctx.measureText(this.data.label).width;
      const boxWidth = labelW + 60 * scale; 
      const boxHeight = fontSizeLabel + fontSizeHint + 40 * scale;
      const boxX = screenX - boxWidth / 2;
      const boxY = screenY - fontSizeLabel; 

      ctx.fillStyle = "rgba(0, 0, 0, 0.85)"; 
      ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
      ctx.strokeStyle = levelColor;
      ctx.lineWidth = 3 * scale;
      ctx.shadowBlur = 10;
      ctx.shadowColor = levelColor;
      ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);
      ctx.restore();

      // æ–‡å­—
      ctx.shadowBlur = 20;
      ctx.shadowColor = levelColor;
      ctx.fillStyle = "#fff";
      ctx.font = `${fontSizeLabel}px 'Press Start 2P'`;
      ctx.textAlign = "center";
      ctx.fillText(this.data.label, screenX, screenY + 10 * scale);
      
      ctx.shadowBlur = 0; 
      ctx.fillStyle = levelColor;
      ctx.font = `${fontSizeHint}px monospace`;
      ctx.fillText(this.data.hint, screenX, screenY + 70 * scale);
    }
  }

  class Particle {
    constructor(x, y, color) {
      this.x = x;
      this.y = y;
      this.color = color;
      const angle = Math.random() * Math.PI * 2;
      const speed = Math.random() * 5 + 2;
      this.vx = Math.cos(angle) * speed;
      this.vy = Math.sin(angle) * speed;
      this.life = 1.0;
      this.decay = Math.random() * 0.03 + 0.02;
    }
    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += 0.2;
      this.life -= this.decay;
    }
    draw(ctx) {
      ctx.globalAlpha = Math.max(0, this.life);
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, 4, 4);
      ctx.globalAlpha = 1.0;
    }
  }

  // --- Game Functions ---

  function spawnEnemy() {
    const currentLevels = GAME_DATA[state.system];
    const pool = currentLevels[state.levelIdx].pool;
    const data = pool[Math.floor(Math.random() * pool.length)];
    entities.enemies.push(new Enemy(data));
  }

  function triggerShake(amount) {
    state.shake = amount;
  }

  function createExplosion(x, y, color) {
    for(let i=0; i<15; i++) {
      entities.particles.push(new Particle(x, y, color));
    }
  }

  function updateHUD() {
    document.getElementById('score-display').innerText = `SCORE: ${state.score.toString().padStart(6, '0')}`;
    document.getElementById('combo-display').innerText = `COMBO: ${state.combo}`;
    
    if (state.screen === 'VICTORY') {
        document.getElementById('level-display').innerText = "SYSTEM HACKED";
        document.getElementById('level-display').style.color = "#fff";
    } else {
        const currentLevels = GAME_DATA[state.system];
        const lvlEl = document.getElementById('level-display');
        lvlEl.innerText = currentLevels[state.levelIdx].name;
        lvlEl.style.color = currentLevels[state.levelIdx].color;
    }

    document.getElementById('system-status').innerText = `SYSTEM: ${state.system}_OS // KEYBOARD_INTERCEPT: ACTIVE`;
  }

  function showTransition(title, subtitle) {
    const el = document.getElementById('level-transition');
    document.getElementById('trans-title').innerText = title;
    document.getElementById('trans-title').style.color = GAME_DATA[state.system][state.levelIdx].color;
    document.getElementById('trans-sub').innerText = subtitle;
    el.style.display = 'block';
    state.transitionTimer = 2.0; 
  }

  // æš´éœ²çµ¦å…¨åŸŸä»¥ä¾› HTML onclick ä½¿ç”¨
  window.selectSystemByClick = function(sys) {
    state.system = sys;
    document.querySelectorAll('.option').forEach(el => el.classList.remove('highlight'));
    if(sys === 'CHROMEBOOK') document.getElementById('opt-chrome').classList.add('highlight');
    if(sys === 'WINDOWS') document.getElementById('opt-win').classList.add('highlight');
    
    AudioSys.playSFX('ui');
    
    // å»¶é²ä¸€é»é»è®“ UI éŸ³æ•ˆæ’­å®Œ
    setTimeout(() => {
        startGame();
    }, 500);
  }

  function startGame() {
    state.screen = 'PLAY';
    state.score = 0;
    state.combo = 0;
    state.levelIdx = 0;
    entities.enemies = [];
    entities.particles = [];
    
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('victory-screen').style.display = 'none';
    document.getElementById('gameover-screen').style.display = 'none';
    updateHUD();
    
    const currentLevel = GAME_DATA[state.system][0];
    showTransition(`LEVEL 1`, currentLevel.name);
    
    AudioSys.playSFX('levelup'); // ä½¿ç”¨ Level Up éŸ³æ•ˆä½œç‚ºé–‹å§‹æç¤º
    AudioSys.playBGM('bgm_game'); // é–‹å§‹æ’­æ”¾éŠæˆ² BGM
  }

  function victory() {
    state.screen = 'VICTORY';
    AudioSys.playBGM('bgm_victory'); // åˆ‡æ›å‹åˆ© BGM
    
    // é¡¯ç¤ºå‹åˆ©ç•«é¢
    document.getElementById('victory-screen').style.display = 'block';
    document.getElementById('victory-score').innerText = `FINAL SCORE: ${state.score}`;
    document.getElementById('level-transition').style.display = 'none';
    updateHUD();
  }

  function gameOver() {
    state.screen = 'GAMEOVER';
    AudioSys.playSFX('error'); // ç­”éŒ¯éŸ³æ•ˆ
    AudioSys.stopBGM(); // åœæ­¢éŸ³æ¨‚
    
    document.getElementById('start-screen').style.display = 'block';
    document.getElementById('level-transition').style.display = 'none';
    
    document.querySelector('#start-screen h1').innerHTML = "GAME<br>OVER";
    document.querySelector('.menu-options').style.display = 'none';
    document.querySelector('.blink-text').innerText = `FINAL SCORE: ${state.score}\nPRESS [ENTER] TO RESTART`;
  }

  // --- Main Loop ---

  let spawnTimer = 0;

  function loop(timestamp) {
    const dt = (timestamp - state.lastTime) / 1000;
    state.lastTime = timestamp;

    ctx.fillStyle = "#050010";
    ctx.fillRect(0, 0, gameW, gameH);
    
    ctx.save();
    if (state.shake > 0) {
      const dx = (Math.random() - 0.5) * state.shake;
      const dy = (Math.random() - 0.5) * state.shake;
      ctx.translate(dx, dy);
      state.shake *= 0.9; 
      if(state.shake < 0.5) state.shake = 0;
    }

    drawBackground(timestamp);

    // è™•ç†å‹åˆ©ç•«é¢çš„ç¶²æ ¼åŠ é€Ÿ
    if (state.screen === 'VICTORY') {
        // ä»€éº¼éƒ½ä¸åšï¼Œè®“èƒŒæ™¯è‡ªå·±è·‘
    } 
    else if (state.screen === 'START') {
        // å¦‚æœé‚„æ²’é–‹å§‹ï¼Œç¢ºä¿æ’­çš„æ˜¯ Menu BGM (ä½†éœ€è¦ä½¿ç”¨è€…äº’å‹•å¾Œæ‰æ’­å¾—å‡ºè²éŸ³)
        // é€™è£¡æˆ‘å€‘ä¸å¼·åˆ¶ loop å‘¼å« playBGMï¼Œé¿å… console åˆ·éŒ¯èª¤
    }
    else if (state.screen === 'PLAY') {
      const currentLevels = GAME_DATA[state.system];
      
      if (state.transitionTimer > 0) {
        state.transitionTimer -= dt;
        if (state.transitionTimer <= 0) {
          document.getElementById('level-transition').style.display = 'none';
        }
      } else {
        spawnTimer += dt;
        const spawnRate = 2.0 - (state.levelIdx * 0.5); 
        if (spawnTimer > spawnRate) {
          spawnEnemy();
          spawnTimer = 0;
        }
      }

      // å‡ç´šé‚è¼¯
      let nextLevel = -1;
      if (state.score > 1500 && state.levelIdx === 0) nextLevel = 1;
      if (state.score > 3500 && state.levelIdx === 1) nextLevel = 2;
      
      // å‹åˆ©æ¢ä»¶ï¼šè¶…é 6000 åˆ†
      if (state.score > 6000) {
        victory();
      }

      if (nextLevel !== -1) {
        state.levelIdx = nextLevel;
        AudioSys.playSFX('levelup');
        triggerShake(10);
        showTransition("LEVEL UP!", currentLevels[state.levelIdx].name);
        updateHUD();
      }

      entities.enemies.forEach((e, i) => {
        const hit = e.update(dt, currentLevels[state.levelIdx].speed);
        if (hit) {
          triggerShake(20);
          AudioSys.playSFX('explode'); // æ’åˆ°ä¹Ÿæ’­çˆ†ç‚¸
          gameOver();
        }
      });
      entities.enemies = entities.enemies.filter(e => e.z > 0);
      
      // Z-Sorting
      entities.enemies.sort((a, b) => b.z - a.z);

      entities.enemies.forEach(e => e.draw(ctx));
      
      updateHUD();
    }

    entities.particles.forEach(p => {
      p.update();
      p.draw(ctx);
    });
    entities.particles = entities.particles.filter(p => p.life > 0);

    ctx.restore();
    requestAnimationFrame(loop);
  }

  function drawBackground(time) {
    const horizonY = gameH * 0.55;
    const sunY = horizonY - 50;

    let currentTheme = { gridColor: "#ff00aa", sunColors: ["#ffdd00", "#ff00aa"] };
    
    // å¦‚æœæ˜¯å‹åˆ©ç•«é¢ï¼Œå¼·åˆ¶ä½¿ç”¨ã€Œé§­å®¢ç™½ã€ä¸»é¡Œ
    if (state.screen === 'VICTORY') {
        currentTheme = { gridColor: "#ffffff", sunColors: ["#ffffff", "#ccffff"] };
    } else if (state.screen === 'PLAY' || state.screen === 'GAMEOVER') {
        currentTheme = GAME_DATA[state.system][state.levelIdx];
    }

    // å¤ªé™½
    const sunGrad = ctx.createLinearGradient(gameCX, sunY - 150, gameCX, sunY + 150);
    sunGrad.addColorStop(0, currentTheme.sunColors[0]);
    sunGrad.addColorStop(1, currentTheme.sunColors[1]);
    
    ctx.save();
    ctx.fillStyle = sunGrad;
    ctx.shadowBlur = (state.screen === 'VICTORY') ? 100 : 50; // å‹åˆ©æ™‚å¤ªé™½æ›´äº®
    ctx.shadowColor = currentTheme.sunColors[1];
    ctx.beginPath();
    ctx.arc(gameCX, sunY, 120, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = "#050010";
    for(let i=0; i<8; i++) {
      let y = sunY + 20 + i * 15;
      let h = 2 + i * 1.5;
      ctx.fillRect(gameCX - 130, y, 260, h);
    }

    // ç¸±å‘ç¶²æ ¼
    ctx.save();
    ctx.strokeStyle = currentTheme.gridColor;
    ctx.lineWidth = 2;
    ctx.shadowBlur = 10;
    ctx.shadowColor = currentTheme.gridColor;
    
    ctx.beginPath();
    for (let i = -20; i <= 20; i++) {
      let x1 = gameCX + i * 40; 
      let x2 = gameCX + i * 800; 
      ctx.moveTo(x1, horizonY);
      ctx.lineTo(x2, gameH);
    }
    ctx.stroke();

    // æ©«å‘ç¶²æ ¼ (å…‰é€Ÿæ•ˆæœ)
    const speed = (state.screen === 'VICTORY') ? 1500 : 150; // å‹åˆ©æ™‚é€Ÿåº¦ x10
    const offset = (time / 1000 * speed) % 100;
    ctx.beginPath();
    for (let i = 0; i < 15; i++) {
      let z = i * 80 + offset;
      let y = horizonY + (z * z) / 2000; 
      if (y < gameH) {
        ctx.moveTo(0, y);
        ctx.lineTo(gameW, y);
      }
    }
    ctx.stroke();
    
    // åœ°å¹³ç·š
    ctx.shadowBlur = 30;
    ctx.shadowColor = "#fff";
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, horizonY);
    ctx.lineTo(gameW, horizonY);
    ctx.stroke();
    
    ctx.restore();
  }

  /**
   * âŒ¨ï¸ è¼¸å…¥ç›£è½
   */
  document.addEventListener('keydown', (e) => {
    // ç¬¬ä¸€æ¬¡æŒ‰éµæ™‚å˜—è©¦æ’­æ”¾ Menu BGM (å› ç‚ºç€è¦½å™¨ç¦æ­¢è‡ªå‹•æ’­æ”¾)
    if (state.screen === 'START' && !AudioSys.currentBGM) {
        AudioSys.playBGM('bgm_menu');
    }

    if (e.ctrlKey || e.altKey || e.metaKey || e.key === 'F5' || e.key === 'F11') {
      e.preventDefault();
    }

    // START
    if (state.screen === 'START') {
      if (e.key.toLowerCase() === 'c') window.selectSystemByClick('CHROMEBOOK');
      if (e.key.toLowerCase() === 'w') window.selectSystemByClick('WINDOWS');
      return;
    }

    // GAME OVER or VICTORY (Reboot)
    if (state.screen === 'GAMEOVER' || state.screen === 'VICTORY') {
      if (e.key === 'Enter') {
        state.screen = 'START';
        document.querySelector('.menu-options').style.display = 'flex';
        document.querySelector('#start-screen h1').innerHTML = "NEON<br>RUNNER";
        document.querySelector('#start-screen .blink-text').innerText = "PRESS KEY TO SELECT SYSTEM";
        document.querySelectorAll('.option').forEach(el => el.classList.remove('highlight'));
        
        // éš±è—å…¶ä»–ç•«é¢
        document.getElementById('start-screen').style.display = 'block';
        document.getElementById('victory-screen').style.display = 'none';
        document.getElementById('gameover-screen').style.display = 'none';
        
        AudioSys.playBGM('bgm_menu'); // å›åˆ°é¸å–®éŸ³æ¨‚
      }
      return;
    }

    if (state.screen !== 'PLAY') return;
    if (state.transitionTimer > 0) return;

    let targetIdx = -1;
    let minZ = Infinity;
    entities.enemies.forEach((en, idx) => {
      if (en.z < minZ) { minZ = en.z; targetIdx = idx; }
    });

    if (targetIdx !== -1) {
      const enemy = entities.enemies[targetIdx];
      const code = enemy.data.code;

      const matchCtrl = !!code.ctrl === e.ctrlKey;
      const matchAlt = !!code.alt === e.altKey;
      const matchMeta = !!code.meta === e.metaKey;
      const matchShift = !!code.shift === e.shiftKey;
      
      let matchKey = false;
      if (code.key) {
        matchKey = e.key.toLowerCase() === code.key.toLowerCase();
      } else {
        matchKey = true; 
      }

      if (matchCtrl && matchAlt && matchMeta && matchShift && matchKey) {
        state.score += 100 + (state.combo * 10);
        state.combo++;
        triggerShake(5);
        AudioSys.playSFX('hit'); // ç­”å°éŸ³æ•ˆ
        
        // å»¶é²ä¸€é»é»æ’­çˆ†ç‚¸éŸ³æ•ˆï¼Œæ›´æœ‰å±¤æ¬¡
        setTimeout(() => AudioSys.playSFX('explode'), 50); 
        
        const scale = 300 / (enemy.z + 10);
        const sx = gameCX + enemy.x * scale;
        const sy = gameH * 0.55 + 40 * scale;
        createExplosion(sx, sy, GAME_DATA[state.system][state.levelIdx].color);
        
        const floatText = document.createElement('div');
        floatText.className = 'floating-text';
        floatText.style.left = sx + 'px';
        floatText.style.top = sy + 'px';
        floatText.innerText = "+100";
        document.body.appendChild(floatText);
        setTimeout(() => floatText.remove(), 1000);

        entities.enemies.splice(targetIdx, 1);
      } else if (e.key.length === 1 || e.key === 'Backspace') { 
        // ç°¡å–®çš„ç­”éŒ¯åˆ¤æ–· (é¿å…æŒ‰ Ctrl æ™‚å°±éŸ¿)
        // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦åŠ å…¥ç­”éŒ¯éŸ³æ•ˆï¼Œç‚ºäº†ä¸æ‰“æ“Šä¿¡å¿ƒï¼Œé€šå¸¸åªåœ¨ Combo æ–·æ‰æˆ– GameOver æ™‚æ’­
      }
    }
  });

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>